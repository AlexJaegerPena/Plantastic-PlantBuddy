name: GitHub Clone and View Count Update

on:
  schedule:
    - cron: "0 */24 * * *" # Läuft alle 24 Stunden
  workflow_dispatch: # Erlaubt manuelles Starten

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: gh login
        run: echo "${{ secrets.SECRET_TOKEN }}" | gh auth login --with-token

      - name: Fetch traffic data (Clones & Views)
        run: |
          # Clones abrufen
          curl -H "Authorization: token ${{ secrets.SECRET_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/traffic/clones \
            > clone.json
            
          # Views abrufen
          curl -H "Authorization: token ${{ secrets.SECRET_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/traffic/views \
            > views.json

      - name: Create or Sync Gist
        id: set_id
        run: |
          if gh secret list | grep -q "GIST_ID"
          then
              echo "GIST_ID found. Downloading existing data..."
              echo "GIST=${{ secrets.GIST_ID }}" >> $GITHUB_OUTPUT
              curl -L https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/clone.json > clone_before.json
              curl -L https://gist.githubusercontent.com/${{ github.actor }}/${{ secrets.GIST_ID }}/raw/views.json > views_before.json
          else
              echo "GIST_ID not found. Creating a new gist..."
              # Initialisiere Gist mit Platzhalter-Dateien
              gist_id=$(gh gist create clone.json views.json | awk -F / '{print $NF}')
              echo $gist_id | gh secret set GIST_ID
              echo "GIST=$gist_id" >> $GITHUB_OUTPUT
              cp clone.json clone_before.json
              cp views.json views_before.json
          fi

      - name: Process data with Python
        run: |
          # Wir laden das Original-Skript für Clones
          curl -s https://raw.githubusercontent.com/MShawon/github-clone-count-badge/master/main.py > main.py
          python3 main.py
          
          # Ein kleiner Python-Hack, um das gleiche für Views zu machen:
          sed -i 's/clone.json/views.json/g' main.py
          sed -i 's/clone_before.json/views_before.json/g' main.py
          python3 main.py

      - name: Update Gist and Markdown
        run: |
          # Gist updaten (beide Dateien: clone.json und views.json)
          clone_content=$(cat clone.json | jq -Rs .)
          views_content=$(cat views.json | jq -Rs .)
          
          echo "{\"files\": {\"clone.json\": {\"content\": $clone_content}, \"views.json\": {\"content\": $views_content}}}" > post_data.json
          
          curl -s -X PATCH \
            -H "Authorization: token ${{ secrets.SECRET_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @post_data.json https://api.github.com/gists/${{ steps.set_id.outputs.GIST }}

          # CLONE.md (oder STATS.md) erstellen/aktualisieren
          shields="https://img.shields.io/badge/dynamic/json?color=success&label"
          url_base="https://gist.githubusercontent.com/${{ github.actor }}/${{ steps.set_id.outputs.GIST }}/raw"
          
          echo "### Repository Statistics" > STATS.md
          echo "[![GitHub Clones]($shields=Clones&query=count&url=$url_base/clone.json&logo=github)](https://github.com/MShawon/github-clone-count-badge)" >> STATS.md
          echo "[![GitHub Views]($shields=Views&query=count&url=$url_base/views.json&logo=github)](https://github.com/MShawon/github-clone-count-badge)" >> STATS.md
          
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add STATS.md
          git commit -m "update stats badges" || exit 0
          git push
